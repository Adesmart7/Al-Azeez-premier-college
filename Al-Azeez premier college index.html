<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Azeez Premier College - School Management System</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- All CSS styles are included here -->
    <style>
        :root {
            --primary: #0a2d57; --secondary: #3a7cbd; --accent: #f39c12; --light: #f5f7fa;
            --dark: #2c3e50; --success: #27ae60; --warning: #e74c3c; --info: #3498db;
            --bg-light: #ecf0f5; --border-color: #dee2e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-light); color: var(--dark); line-height: 1.6; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: var(--primary); color: white; transition: all 0.3s ease; position: fixed; height: 100vh; overflow-y: auto; z-index: 1001; }
        .logo-container { padding: 20px; text-align: center; background: var(--primary); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; align-items: center; }
        .school-logo { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 3px solid var(--accent); overflow: hidden; background: white; }
        .school-logo img { width: 100%; height: auto; object-fit: cover; }
        .logo { font-size: 1.4rem; font-weight: bold; color: white; margin-bottom: 5px; }
        .slogan { font-size: 0.8rem; color: var(--accent); font-style: italic; }
        .menu { padding: 10px 0; }
        .menu-item { padding: 15px 20px; display: flex; align-items: center; cursor: pointer; transition: all 0.3s; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background: var(--secondary); border-left: 4pesolid var(--accent); }
        .menu-item i { margin-right: 15px; font-size: 1.2rem; width: 24px; text-align: center; }
        .main-content { flex: 1; display: flex; flex-direction: column; margin-left: 250px; width: calc(100% - 250px); transition: margin-left 0.3s ease, width 0.3s ease; }
        .header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .search-box { display: flex; align-items: center; background: var(--light); border-radius: 20px; padding: 5px 15px; width: 300px; }
        .search-box input { border: none; background: transparent; padding: 8px; width: 100%; outline: none; }
        .user-info { display: flex; align-items: center; cursor: pointer; position: relative; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        #logout-btn { position: absolute; top: 50px; right: 0; background-color: white; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; cursor: pointer; width: 120px; text-align: center; }
        #logout-btn:hover { background-color: var(--light); }
        .content { padding: 30px; flex: 1; }
        .page { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page.active { display: block; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .stat-card { display: flex; align-items: center; }
        .stat-icon { width: 60px; height: 60px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; }
        .bg-primary { background: rgba(26, 79, 140, 0.2); color: var(--primary); }
        .bg-success { background: rgba(39, 174, 96, 0.2); color: var(--success); }
        .bg-warning { background: rgba(243, 156, 18, 0.2); color: var(--accent); }
        .bg-info { background: rgba(52, 152, 219, 0.2); color: var(--info); }
        .stat-info h3 { font-size: 24px; margin-bottom: 5px; }
        .stat-info p { color: #6c757d; font-size: 14px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: var(--light); font-weight: 600; }
        tr:hover { background: #f5f9ff; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .form-row { display: flex; gap: 20px; margin-bottom: 0; }
        .form-row .form-group { flex: 1; }
        .report-card-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 900px; margin: 20px auto; }
        .rc-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; }
        .rc-header-logo img { width: 80px; }
        .rc-header-text { text-align: center; }
        .rc-header-text h2 { color: var(--primary); margin: 0; }
        .rc-header-text p { margin: 5px 0; }
        .rc-header-photo img { width: 90px; height: 90px; border: 3px solid var(--primary); border-radius: 5px; object-fit: cover;}
        .rc-title { text-align: center; margin: 15px 0; font-size: 1.2rem; background: var(--primary); color: white; padding: 5px; border-radius: 5px;}
        .rc-section { margin-bottom: 15px; }
        .rc-table { width: 100%; font-size: 0.9rem; border-collapse: collapse; }
        .rc-table th, .rc-table td { border: 1px solid var(--border-color); padding: 6px 8px; text-align: center; }
        .rc-table th { background: var(--bg-light); font-weight: 600; }
        .rc-table .subject { text-align: left; }
        .rc-grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .rc-comments-section { border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; }
        .rc-comments-section p { margin-bottom: 5px;}
        .rc-comments-section textarea { width: 100%; border-radius: 5px; padding: 5px; border: 1px solid var(--border-color); font-family: inherit; }
        .rc-signature { margin-top: 15px; text-align: center; font-size: 0.9em; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 80%; max-width: 600px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #login-modal { z-index: 2000; background-color: rgba(0,0,0,0.7); }
        #login-modal .modal-content { max-width: 400px; }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; animation: fadeIn 0.3s; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Skeleton Loader Styles */
        .skeleton-loader {
            background-color: #e0e0e0;
            background-image: linear-gradient(90deg, #e0e0e0 0px, #f5f5f5 40px, #e0e0e0 80px);
            background-size: 600px 100%;
            background-repeat: no-repeat;
            border-radius: 5px;
            animation: skeleton-shimmer 1.5s infinite linear;
        }
        .skeleton-text { height: 1.2em; margin-bottom: 0.5em; }
        .skeleton-row { display: flex; align-items: center; height: 50px; }
        .skeleton-cell { height: 20px; margin-right: 15px; }

        @keyframes skeleton-shimmer {
            from { background-position: -600px 0; }
            to { background-position: 600px 0; }
        }

        @media print {
            body * { visibility: hidden; }
            .report-card-container, .report-card-container * { visibility: visible; }
            .report-card-container { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; padding: 0; }
            .no-print { display: none !important; }
        }
        @media (max-width: 992px) {
            .sidebar { width: 80px; } .logo, .slogan, .menu-item span { display: none; }
            .main-content { margin-left: 80px; width: calc(100% - 80px); }
            .menu-item { justify-content: center; } .menu-item i { margin-right: 0; font-size: 1.5rem; }
            .rc-grid-container { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .dashboard-cards { grid-template-columns: 1fr; } .search-box { display: none; } .form-row { flex-direction: column; gap: 0; }
        }
        @media (max-width: 576px) {
            .header { padding: 15px; } .main-content { margin-left: 0; width: 100%; } .sidebar { width: 0; overflow: hidden; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px;">Loading...</p>
    </div>

    <!-- Login/Sign Up Modal -->
    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="https://i.ibb.co/6g2wz6Q/logo.jpg" alt="Logo" style="width: 70px;">
                <h3 id="modal-title">Staff Login</h3>
            </div>
            
            <!-- Login Form -->
            <form id="login-form">
                <div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-control" required></div>
                <div class="form-group"><label for="password">Password</label><input type="password" id="password" class="form-control" required></div>
                <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
                <p id="login-error" style="color: var(--warning); text-align: center; margin-top: 10px;"></p>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" id="show-signup-btn">Don't have an account? Sign up</a>
                </div>
            </form>

            <!-- Sign Up Form (Initially hidden) -->
            <form id="signup-form" class="hidden">
                <div class="form-group"><label for="signup-name">Full Name</label><input type="text" id="signup-name" class="form-control" required></div>
                <div class="form-group"><label for="signup-email">Email</label><input type="email" id="signup-email" class="form-control" required></div>
                <div class="form-group"><label for="signup-password">Password</label><input type="password" id="signup-password" class="form-control" required></div>
                <button type="submit" class="btn btn-primary" id="signup-btn">Sign Up</button>
                <p id="signup-error" style="color: var(--warning); text-align: center; margin-top: 10px;"></p>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" id="show-login-btn">Already have an account? Login</a>
                </div>
            </form>

        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container">
            <div class="sidebar">
                <div class="logo-container">
                    <div class="school-logo"><img src="https://i.ibb.co/6g2wz6Q/logo.jpg" alt="School Logo"></div>
                    <div class="logo">Al-Azeez Premier</div>
                    <div class="slogan">Epitome of Excellence</div>
                </div>
                <div class="menu">
                    <div class="menu-item active" data-page="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></div>
                    <div class="menu-item" data-page="students"><i class="fas fa-user-graduate"></i><span>Students</span></div>
                    <div class="menu-item" data-page="grades"><i class="fas fa-edit"></i><span>Enter Grades</span></div>
                    <div class="menu-item role-admin-only" data-page="teachers"><i class="fas fa-chalkboard-teacher"></i><span>Staff</span></div>
                    <div class="menu-item" data-page="reports"><i class="fas fa-file-alt"></i><span>Report Cards</span></div>
                    <div class="menu-item role-admin-only" data-page="settings"><i class="fas fa-cog"></i><span>Settings</span></div>
                    <div class="menu-item" data-page="help"><i class="fas fa-question-circle"></i><span>Help</span></div>
                </div>
            </div>
            <div class="main-content">
                <div class="header">
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="Search..."></div>
                    <div class="user-info" id="user-profile">
                        <img src="https://ui-avatars.com/api/?name=A+U" id="user-avatar" alt="User">
                        <div><h4 id="user-name"></h4><small id="user-role"></small></div>
                        <div id="logout-btn">Logout</div>
                    </div>
                </div>
                <div class="content">
                    <div id="dashboard" class="page active">
                          <h1>School Dashboard</h1><p>Welcome to the Al-Azeez Premier College Management System.</p>
                          <div class="dashboard-cards">
                              <div class="card stat-card"><div class="stat-icon bg-primary"><i class="fas fa-user-graduate"></i></div><div class="stat-info"><h3 id="total-students">0</h3><p>Total Students</p></div></div>
                              <div class="card stat-card"><div class="stat-icon bg-success"><i class="fas fa-chalkboard-teacher"></i></div><div class="stat-info"><h3 id="total-teachers">0</h3><p>Teaching Staff</p></div></div>
                          </div>
                          <div class="content-header" style="margin-top: 30px;"><h2>Quick Actions</h2></div>
                          <div class="dashboard-cards">
                              <button class="btn btn-primary" id="take-attendance-btn"><i class="fas fa-calendar-check"></i> Take Attendance</button>
                              <button class="btn btn-primary role-admin-only" id="add-student-btn-dash"><i class="fas fa-user-plus"></i> Add Student</button>
                              <button class="btn btn-primary" onclick="showPage('reports')"><i class="fas fa-file-invoice"></i> View Reports</button>
                          </div>
                    </div>
                    <div id="students" class="page">
                        <div class="content-header"><h2>Student Management</h2><button class="btn btn-primary role-admin-only" id="add-student-btn">Add New Student</button></div>
                        <div class="card">
                            <div class="form-row" style="margin-bottom: 20px;">
                                <div class="form-group"><input type="text" id="searchStudent" class="form-control" placeholder="Search by name or ID..."></div>
                                <div class="form-group"><select id="filterClass" class="form-control"><option value="">All Classes</option></select></div>
                            </div>
                            <div id="students-table-container">
                                <table>
                                    <thead>
                                        <tr><th>ID</th><th>Name</th><th>Class</th><th>Gender</th><th class="role-admin-only">Actions</th></tr>
                                    </thead>
                                    <tbody id="students-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="grades" class="page">
                        <div class="content-header"><h2>Enter Student Scores</h2></div>
                        <div class="card">
                            <div class="form-row">
                                <div class="form-group"><label>Class</label><select id="grades-class" class="form-control"></select></div>
                                <div class="form-group"><label>Student</label><select id="grades-student" class="form-control"></select></div>
                                <div class="form-group"><label>Term</label><select id="grades-term" class="form-control"><option value="1">First</option><option value="2">Second</option><option value="3">Third</option></select></div>
                            </div>
                            <div id="grades-entry-table"></div>
                        </div>
                    </div>
                    <div id="reports" class="page">
                        <div class="content-header"><h2>Report Card Generation</h2></div>
                        <div class="card">
                            <div class="form-row">
                                <div class="form-group"><label for="reportClass">Class</label><select id="reportClass" class="form-control"></select></div>
                                <div class="form-group"><label for="reportStudent">Student</label><select id="reportStudent" class="form-control"></select></div>
                                <div class="form-group"><label for="reportTerm">Term</label><select id="reportTerm" class="form-control"><option value="1">First</option><option value="2">Second</option><option value="3">Third</option></select></div>
                            </div>
                            <button class="btn btn-primary" id="generate-report-btn">Generate Report</button>
                        </div>
                        <div id="report-card-display"></div>
                    </div>
                    <div id="teachers" class="page role-admin-only">
                        <div class="content-header"><h2>Staff Management</h2><button class="btn btn-primary" id="add-staff-btn">Add New Staff</button></div>
                        <div class="card">
                            <div id="staff-table-container">
                                <table>
                                    <thead>
                                        <tr><th>Name</th><th>Email</th><th>Role</th><th>Class Assigned</th><th class="role-admin-only">Actions</th></tr>
                                    </thead>
                                    <tbody id="staff-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="settings" class="page role-admin-only">
                        <div class="content-header"><h2>General Settings</h2></div>
                        <div class="card">
                            <form id="settings-form">
                                <div class="form-group"><label for="nextTermBegins">Next Term Begins Date</label><input type="date" id="nextTermBegins" class="form-control"></div>
                                <button type="submit" class="btn btn-primary" id="save-settings-btn">Save Settings</button>
                            </form>
                        </div>
                    </div>
                    <div id="help" class="page"><div class="content-header"><h2>Help & Support</h2></div><div class="card"><p>For assistance, contact support at <strong>support@alazeezpremier.edu.ng</strong>.</p></div></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modals -->
    <div id="studentModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2 id="student-modal-title">Add New Student</h2><form id="student-form"><input type="hidden" id="studentId"><div class="form-row"><div class="form-group"><label for="studentName">Full Name</label><input type="text" id="studentName" class="form-control" required></div><div class="form-group"><label for="studentClass">Class</label><select id="studentClass" class="form-control" required></select></div></div><div class="form-row"><div class="form-group"><label for="studentGender">Gender</label><select id="studentGender" class="form-control" required><option value="Male">Male</option><option value="Female">Female</option></select></div><div class="form-group"><label for="studentDob">Date of Birth</label><input type="date" id="studentDob" class="form-control" required></div></div><div class="form-row"><div class="form-group"><label for="studentParent">Parent/Guardian</label><input type="text" id="studentParent" class="form-control" required></div><div class="form-group"><label for="studentContact">Contact Number</label><input type="tel" id="studentContact" class="form-control" required></div></div><button type="submit" class="btn btn-primary" id="save-student-btn">Save Student</button></form></div></div>
    <div id="takeAttendanceModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2>Take Attendance</h2></div></div>
    <div id="staffModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2>Add New Staff</h2><form id="staff-form"><div class="form-group"><label>Full Name</label><input type="text" id="staff-name" class="form-control" required></div><div class="form-group"><label>Email</label><input type="email" id="staff-email" class="form-control" required></div><div class="form-group"><label>Password</label><input type="password" id="staff-password" class="form-control" required></div><div class="form-group"><label>Role</label><select id="staff-role" class="form-control"><option value="teacher">Teacher</option><option value="admin">Admin</option></select></div><div class="form-group"><label>Assign to Class</label><select id="staff-class" class="form-control"></select></div><button type="submit" class="btn btn-primary" id="save-staff-btn">Create Account</button></form></div></div>
    <div id="message-modal" class="modal"><div class="modal-content"><span class="close">&times;</span><h3 id="message-modal-title"></h3><p id="message-modal-text"></p><div style="text-align: center; margin-top: 20px;"><button class="btn btn-primary" id="message-modal-close-btn">OK</button></div></div></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, where, writeBatch, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        let app, auth, db;
        let currentUser = null;
        let localStudents = [];
        let localStaff = [];
        let schoolInfo = {};
        let unsubscribe = {};
        const subjectSchema = {
            JSS: ["English Language", "Mathematics", "Basic Science & Technology", "National Values Education", "Pre-Vocational Studies", "Yoruba Language", "Cultural & Creative Arts", "French", "Islamic Studies"],
            SSS_Science: ["English Language", "Mathematics", "Civic Education", "Physics", "Chemistry", "Biology", "Yoruba Language", "Animal Husbandry", "Technical Drawing"],
            SSS_Art: ["English Language", "Mathematics", "Civic Education", "Literature in English", "Government", "History", "Islamic Studies", "Yoruba Language", "Economics"],
            SSS_Commercial: ["English Language", "Mathematics", "Civic Education", "Economics", "Commerce", "Accounting", "Yoruba Language", "Book Keeping", "Office Practice"]
        };
        const classes = ["JSS1", "JSS2", "JSS3", "SSS1 Science", "SSS1 Art", "SSS2 Science", "SSS2 Art", "SSS3 Science", "SSS3 Art", "SSS3 Commercial"];

        const loginModal = document.getElementById('login-modal');
        const appContainer = document.getElementById('app-container');
        const userProfile = document.getElementById('user-profile');
        const logoutBtn = document.getElementById('logout-btn');
        const studentModal = document.getElementById('studentModal');
        const staffModal = document.getElementById('staffModal');
        const messageModal = document.getElementById('message-modal');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showLoginBtn = document.getElementById('show-login-btn');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const modalTitle = document.getElementById('modal-title');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const saveStudentBtn = document.getElementById('save-student-btn');
        const saveStaffBtn = document.getElementById('save-staff-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const studentsTableBody = document.getElementById('students-table-body');
        const staffTableBody = document.getElementById('staff-table-body');

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        async function init() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                console.log("Firebase initialized successfully.");

                onAuthStateChanged(auth, handleAuthStateChange);

                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } catch (error) {
                        console.error("Error signing in with custom token: ", error);
                        // Fallback to anonymous sign-in or stay on login screen
                        // For now, let onAuthStateChanged handle the login modal if the token is invalid
                    }
                } else {
                    console.log("No custom token available, showing login screen.");
                }

            } catch (error) {
                console.error("Firebase initialization error: ", error);
                showMessageModal("Initialization Error", "Failed to initialize the application. Please try again later.");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            init();

            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); toggleForms('login'); });
            showSignupBtn.addEventListener('click', (e) => { e.preventDefault(); toggleForms('signup'); });

            userProfile.addEventListener('click', () => { logoutBtn.style.display = logoutBtn.style.display === 'block' ? 'none' : 'block'; });
            logoutBtn.addEventListener('click', () => signOut(auth));

            document.querySelectorAll('.modal .close').forEach(btn => btn.addEventListener('click', () => hideModal(btn.closest('.modal'))));
            messageModal.querySelector('.btn').addEventListener('click', () => hideModal(messageModal));

            populateClassDropdowns();
            setupEventListeners();
        });

        function toggleForms(formType) {
            if (formType === 'login') {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                modalTitle.textContent = "Staff Login";
                document.getElementById('login-error').textContent = '';
                document.getElementById('signup-error').textContent = '';
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                modalTitle.textContent = "Staff Sign Up";
                document.getElementById('login-error').textContent = '';
                document.getElementById('signup-error').textContent = '';
            }
        }

        async function handleAuthStateChange(user) {
            if (user) {
                try {
                    const userDocRef = doc(db, `artifacts/${__app_id}/public/users`, user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                        hideModal(loginModal);
                        appContainer.classList.remove('hidden');
                        setupUIForUser();
                        attachDataListeners();
                    } else {
                        // User exists in Auth, but not in Firestore. This is a common issue.
                        // We will allow them to create a profile now.
                        showMessageModal("Profile Not Found", "Your account exists, but your profile is not set up. Please try signing up to create your profile.");
                        await signOut(auth);
                    }
                } catch (error) {
                    console.error("Error fetching user profile: ", error);
                    showMessageModal("Error", "Could not load user data. Please try again later.");
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                appContainer.classList.add('hidden');
                loginModal.style.display = 'flex';
                detachDataListeners();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = "";
            loginBtn.textContent = "Logging in...";
            loginBtn.disabled = true;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error: ", error);
                if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorEl.textContent = "Invalid email or password. Please try again.";
                } else {
                    errorEl.textContent = "Login failed. Please check your network connection.";
                }
            } finally {
                loginBtn.textContent = "Login";
                loginBtn.disabled = false;
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const staffName = document.getElementById('signup-name').value;
            const staffEmail = document.getElementById('signup-email').value;
            const staffPassword = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            errorEl.textContent = "";
            signupBtn.textContent = "Signing up...";
            signupBtn.disabled = true;

            try {
                // Check if any users exist at all before creating the new one.
                const usersCollectionRef = collection(db, `artifacts/${__app_id}/public/users`);
                const querySnapshot = await getDocs(usersCollectionRef);
                const existingUsersCount = querySnapshot.size;
                const role = existingUsersCount === 0 ? 'admin' : 'teacher';

                const userCredential = await createUserWithEmailAndPassword(auth, staffEmail, staffPassword);
                await setDoc(doc(db, `artifacts/${__app_id}/public/users`, userCredential.user.uid), {
                    name: staffName,
                    email: staffEmail,
                    role: role,
                    assignedClass: null
                });
                showMessageModal("Success", `Account created successfully! You are now logged in as ${role}.`);
                hideModal(loginModal);
                toggleForms('login');
            } catch (error) {
                console.error("Error creating staff account: ", error);
                if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = "This email is already in use. Please log in or use a different email.";
                } else if (error.code === 'auth/weak-password') {
                    errorEl.textContent = "Password is too weak. Please choose a stronger password.";
                } else {
                    errorEl.textContent = "Failed to create account. Please try again or contact an admin.";
                }
            } finally {
                signupBtn.textContent = "Sign Up";
                signupBtn.disabled = false;
            }
        }


        function setupUIForUser() {
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrator' : `Teacher (${currentUser.assignedClass})`;
            document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${currentUser.name.replace(' ','+')}&background=0a2d57&color=fff`;
            
            document.querySelectorAll('.role-admin-only').forEach(el => { el.style.display = currentUser.role === 'admin' ? '' : 'none'; });
            
            if (currentUser.role === 'teacher') {
                const classToAssign = currentUser.assignedClass;
                document.querySelectorAll('#grades-class, #reportClass').forEach(sel => {
                    sel.innerHTML = `<option value="${classToAssign}">${classToAssign}</option>`;
                    sel.value = classToAssign;
                    sel.disabled = true;
                    sel.dispatchEvent(new Event('change'));
                });
            }
            showPage('dashboard');
        }

        function attachDataListeners() {
            renderStudents(true);
            renderStaff(true);
            
            const studentsQuery = currentUser.role === 'admin' 
                ? collection(db, `artifacts/${__app_id}/public/data/students`)
                : query(collection(db, `artifacts/${__app_id}/public/data/students`), where("class", "==", currentUser.assignedClass));
            
            unsubscribe.students = onSnapshot(studentsQuery, snapshot => {
                localStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudents(false);
                updateDashboard();
            }, error => console.error("Error listening to students: ", error));

            if (currentUser.role === 'admin') {
                unsubscribe.staff = onSnapshot(collection(db, `artifacts/${__app_id}/public/users`), snapshot => {
                    localStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateDashboard();
                    renderStaff(false);
                }, error => console.error("Error listening to staff: ", error));
                
                unsubscribe.schoolInfo = onSnapshot(doc(db, `artifacts/${__app_id}/public/data`, "schoolInfo"), doc => {
                    if (doc.exists()) {
                        schoolInfo = doc.data();
                        document.getElementById('nextTermBegins').value = schoolInfo.nextTermBegins || '';
                    }
                }, error => console.error("Error listening to schoolInfo: ", error));
            }
        }

        function detachDataListeners() {
            Object.values(unsubscribe).forEach(unsub => unsub && unsub());
            unsubscribe = {};
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.menu-item[data-page="${pageId}"]`).classList.add('active');
        }

        function showModal(modal) { modal.style.display = 'flex'; }
        function hideModal(modal) { modal.style.display = 'none'; }
        
        function showMessageModal(title, message) {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-text').textContent = message;
            showModal(messageModal);
        }

        function populateClassDropdowns() {
            const classDropdowns = document.querySelectorAll('#studentClass, #filterClass, #grades-class, #reportClass, #staff-class');
            classDropdowns.forEach(dropdown => {
                if (dropdown.id !== 'filterClass') { dropdown.innerHTML = ''; }
                if (dropdown.id !== 'filterClass' && dropdown.id !== 'staff-class') { dropdown.innerHTML += '<option value="">Select Class</option>'; }
                if (dropdown.id === 'filterClass') { dropdown.innerHTML = '<option value="">All Classes</option>'; }
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    dropdown.appendChild(option);
                });
            });
        }
        
        function updateDashboard() {
            document.getElementById('total-students').textContent = localStudents.length;
            document.getElementById('total-teachers').textContent = localStaff.length;
        }

        function renderSkeletonLoader(tableBody, columns) {
            tableBody.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const row = document.createElement('tr');
                let rowHTML = '';
                for (let j = 0; j < columns; j++) {
                    rowHTML += `<td><div class="skeleton-loader" style="width: 80%; height: 1.2em;"></div></td>`;
                }
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            }
        }

        function renderStudents(isLoading = false) {
            if (isLoading) {
                renderSkeletonLoader(studentsTableBody, 5);
                return;
            }
            
            studentsTableBody.innerHTML = '';

            const studentsToRender = localStudents.filter(s => {
                const search = document.getElementById('searchStudent').value.toLowerCase();
                const filter = document.getElementById('filterClass').value;
                const matchesSearch = s.name.toLowerCase().includes(search) || s.id.toLowerCase().includes(search);
                const matchesFilter = !filter || s.class === filter;
                return matchesSearch && matchesFilter;
            });

            if (studentsToRender.length === 0) {
                 studentsTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No students found.</td></tr>`;
                 return;
            }

            studentsToRender.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id.substring(0, 8)}</td>
                    <td>${student.name}</td>
                    <td>${student.class}</td>
                    <td>${student.gender}</td>
                    <td class="role-admin-only">
                        <button class="btn" onclick="editStudent('${student.id}')">Edit</button>
                        <button class="btn" onclick="deleteStudent('${student.id}')">Delete</button>
                    </td>
                `;
                studentsTableBody.appendChild(row);
            });
            document.querySelectorAll('.role-admin-only').forEach(el => { el.style.display = currentUser.role === 'admin' ? '' : 'none'; });
        }

        function renderStaff(isLoading = false) {
            if (isLoading) {
                renderSkeletonLoader(staffTableBody, 5);
                return;
            }

            staffTableBody.innerHTML = '';

            if (localStaff.length === 0) {
                staffTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No staff found.</td></tr>`;
                return;
            }

            localStaff.forEach(staff => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${staff.name}</td>
                    <td>${staff.email}</td>
                    <td>${staff.role}</td>
                    <td>${staff.assignedClass || 'N/A'}</td>
                    <td class="role-admin-only">
                        <button class="btn" onclick="deleteStaff('${staff.id}')">Delete</button>
                    </td>
                `;
                staffTableBody.appendChild(row);
            });
            document.querySelectorAll('.role-admin-only').forEach(el => { el.style.display = currentUser.role === 'admin' ? '' : 'none'; });
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.menu-item').forEach(item => item.addEventListener('click', () => showPage(item.dataset.page)));
            
            document.getElementById('add-student-btn').addEventListener('click', () => { showModal(studentModal); document.getElementById('student-form').reset(); });
            document.getElementById('add-student-btn-dash').addEventListener('click', () => { showModal(studentModal); document.getElementById('student-form').reset(); });
            document.getElementById('student-form').addEventListener('submit', handleStudentFormSubmit);
            
            const debouncedRenderStudents = debounce(() => renderStudents(false), 300);
            document.getElementById('searchStudent').addEventListener('input', debouncedRenderStudents);
            document.getElementById('filterClass').addEventListener('change', debouncedRenderStudents);

            document.getElementById('grades-class').addEventListener('change', populateGradesStudentDropdown);
            document.getElementById('grades-student').addEventListener('change', loadGradeSheet);
            document.getElementById('grades-term').addEventListener('change', loadGradeSheet);

            document.getElementById('add-staff-btn').addEventListener('click', () => showModal(staffModal));
            document.getElementById('staff-form').addEventListener('submit', handleStaffFormSubmit);
            
            document.getElementById('generate-report-btn').addEventListener('click', generateReportCard);
            document.getElementById('reportClass').addEventListener('change', populateReportStudentDropdown);
            document.getElementById('settings-form').addEventListener('submit', saveSettings);
        }
        
        async function handleStudentFormSubmit(e) {
            e.preventDefault();
            const studentData = {
                name: document.getElementById('studentName').value,
                class: document.getElementById('studentClass').value,
                gender: document.getElementById('studentGender').value,
                dob: document.getElementById('studentDob').value,
                parent: document.getElementById('studentParent').value,
                contact: document.getElementById('studentContact').value,
                createdAt: new Date()
            };
            const studentId = document.getElementById('studentId').value;
            const studentsCollection = collection(db, `artifacts/${__app_id}/public/data/students`);
            saveStudentBtn.textContent = "Saving...";
            saveStudentBtn.disabled = true;
            try {
                if (studentId) {
                    await updateDoc(doc(studentsCollection, studentId), studentData);
                    showMessageModal("Success", "Student updated successfully!");
                } else {
                    await addDoc(studentsCollection, studentData);
                    showMessageModal("Success", "Student added successfully!");
                }
                hideModal(studentModal);
            } catch (error) {
                console.error("Error saving student: ", error);
                showMessageModal("Error", "Failed to save student.");
            } finally {
                saveStudentBtn.textContent = "Save Student";
                saveStudentBtn.disabled = false;
            }
        }
        window.editStudent = async function(id) {
            const student = localStudents.find(s => s.id === id);
            if (!student) return;
            document.getElementById('studentId').value = id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentClass').value = student.class;
            document.getElementById('studentGender').value = student.gender;
            document.getElementById('studentDob').value = student.dob;
            document.getElementById('studentParent').value = student.parent;
            document.getElementById('studentContact').value = student.contact;
            showModal(studentModal);
        }
        window.deleteStudent = async function(id) {
             const userConfirmed = new Promise((resolve) => {
                const message = "Are you sure you want to delete this student? This action cannot be undone.";
                const confirmModal = document.getElementById('message-modal');
                document.getElementById('message-modal-title').textContent = "Confirm Deletion";
                document.getElementById('message-modal-text').textContent = message;
                const okBtn = document.getElementById('message-modal-close-btn');
                const closeBtn = confirmModal.querySelector('.close');
                okBtn.textContent = "Yes, Delete";
                okBtn.style.background = 'var(--warning)';

                const handleConfirm = () => {
                    resolve(true);
                    hideModal(confirmModal);
                    okBtn.removeEventListener('click', handleConfirm);
                    closeBtn.removeEventListener('click', handleReject);
                };

                const handleReject = () => {
                    resolve(false);
                    hideModal(confirmModal);
                    okBtn.removeEventListener('click', handleConfirm);
                    closeBtn.removeEventListener('click', handleReject);
                };

                okBtn.addEventListener('click', handleConfirm);
                closeBtn.addEventListener('click', handleReject);
                showModal(confirmModal);
            });
            if (await userConfirmed) {
                try {
                    await deleteDoc(doc(db, `artifacts/${__app_id}/public/data/students`, id));
                    showMessageModal("Success", "Student deleted successfully!");
                } catch (error) {
                    console.error("Error deleting student: ", error);
                    showMessageModal("Error", "Failed to delete student.");
                } finally {
                    document.getElementById('message-modal-close-btn').textContent = "OK";
                    document.getElementById('message-modal-close-btn').style.background = 'var(--primary)';
                }
            }
        }
        
        async function handleStaffFormSubmit(e) {
            e.preventDefault();
            const staffName = document.getElementById('staff-name').value;
            const staffEmail = document.getElementById('staff-email').value;
            const staffPassword = document.getElementById('staff-password').value;
            const staffRole = document.getElementById('staff-role').value;
            const staffClass = document.getElementById('staff-class').value || null;

            if (staffRole === 'teacher' && !staffClass) {
                showMessageModal("Error", "A class must be assigned for a teacher role.");
                return;
            }

            saveStaffBtn.textContent = "Creating...";
            saveStaffBtn.disabled = true;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, staffEmail, staffPassword);
                await setDoc(doc(db, `artifacts/${__app_id}/public/users`, userCredential.user.uid), {
                    name: staffName,
                    email: staffEmail,
                    role: staffRole,
                    assignedClass: staffClass
                });
                showMessageModal("Success", "Staff account created successfully!");
                hideModal(staffModal);
                document.getElementById('staff-form').reset();
            } catch (error) {
                console.error("Error creating staff account: ", error);
                showMessageModal("Error", "Failed to create staff account. Check if email is already in use.");
            } finally {
                saveStaffBtn.textContent = "Create Account";
                saveStaffBtn.disabled = false;
            }
        }
        window.deleteStaff = async function(id) {
            const userConfirmed = new Promise((resolve) => {
                const message = "Are you sure you want to delete this staff account? This action cannot be undone.";
                const confirmModal = document.getElementById('message-modal');
                document.getElementById('message-modal-title').textContent = "Confirm Deletion";
                document.getElementById('message-modal-text').textContent = message;
                const okBtn = document.getElementById('message-modal-close-btn');
                const closeBtn = confirmModal.querySelector('.close');
                okBtn.textContent = "Yes, Delete";
                okBtn.style.background = 'var(--warning)';

                const handleConfirm = () => {
                    resolve(true);
                    hideModal(confirmModal);
                    okBtn.removeEventListener('click', handleConfirm);
                    closeBtn.removeEventListener('click', handleReject);
                };

                const handleReject = () => {
                    resolve(false);
                    hideModal(confirmModal);
                    okBtn.removeEventListener('click', handleConfirm);
                    closeBtn.removeEventListener('click', handleReject);
                };

                okBtn.addEventListener('click', handleConfirm);
                closeBtn.addEventListener('click', handleReject);
                showModal(confirmModal);
            });
            if (await userConfirmed) {
                try {
                    await deleteDoc(doc(db, `artifacts/${__app_id}/public/users`, id));
                    showMessageModal("Success", "Staff account deleted successfully!");
                } catch (error) {
                    console.error("Error deleting staff account: ", error);
                    showMessageModal("Error", "Failed to delete staff account.");
                } finally {
                    document.getElementById('message-modal-close-btn').textContent = "OK";
                    document.getElementById('message-modal-close-btn').style.background = 'var(--primary)';
                }
            }
        }
        
        function populateGradesStudentDropdown() {
            const studentSelect = document.getElementById('grades-student');
            const selectedClass = document.getElementById('grades-class').value;
            studentSelect.innerHTML = '<option value="">Select Student</option>';
            const studentsInClass = localStudents.filter(s => s.class === selectedClass);
            studentsInClass.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                studentSelect.appendChild(option);
            });
            loadGradeSheet();
        }

        async function loadGradeSheet() {
            const studentId = document.getElementById('grades-student').value;
            const studentClass = document.getElementById('grades-class').value;
            const term = document.getElementById('grades-term').value;
            const gradesTable = document.getElementById('grades-entry-table');
            
            if (!studentId || !studentClass || !term) {
                gradesTable.innerHTML = '';
                return;
            }

            const student = localStudents.find(s => s.id === studentId);
            if (!student) return;

            const classType = studentClass.includes('JSS') ? 'JSS' : studentClass.split(' ')[1];
            const subjects = subjectSchema[classType];
            
            const gradesDocRef = doc(db, `artifacts/${__app_id}/public/data/grades/${studentId}`);
            const gradesDoc = await getDoc(gradesDocRef);
            const currentGrades = gradesDoc.exists() ? gradesDoc.data() : {};
            
            let tableHTML = `<table><thead><tr><th>Subject</th><th>Score</th></tr></thead><tbody>`;
            subjects.forEach(subject => {
                const score = currentGrades[term]?.[subject] || '';
                tableHTML += `
                    <tr>
                        <td>${subject}</td>
                        <td><input type="number" min="0" max="100" value="${score}" data-subject="${subject}" class="form-control"></td>
                    </tr>
                `;
            });
            tableHTML += `</tbody></table><button class="btn btn-primary" onclick="saveGrades()">Save Grades</button>`;
            gradesTable.innerHTML = tableHTML;
        }

        window.saveGrades = async function() {
            const studentId = document.getElementById('grades-student').value;
            const term = document.getElementById('grades-term').value;
            if (!studentId || !term) return;

            const saveBtn = document.querySelector('#grades-entry-table .btn');
            saveBtn.textContent = "Saving...";
            saveBtn.disabled = true;

            const grades = {};
            document.querySelectorAll('#grades-entry-table input').forEach(input => {
                const subject = input.dataset.subject;
                const score = parseInt(input.value, 10);
                if (!isNaN(score)) grades[subject] = score;
            });

            try {
                const gradesDocRef = doc(db, `artifacts/${__app_id}/public/data/grades/${studentId}`);
                await setDoc(gradesDocRef, { [term]: grades }, { merge: true });
                showMessageModal("Success", "Grades saved successfully!");
            } catch (error) {
                console.error("Error saving grades: ", error);
                showMessageModal("Error", "Failed to save grades.");
            } finally {
                saveBtn.textContent = "Save Grades";
                saveBtn.disabled = false;
            }
        }
        
        function populateReportStudentDropdown() {
            const studentSelect = document.getElementById('reportStudent');
            const selectedClass = document.getElementById('reportClass').value;
            studentSelect.innerHTML = '<option value="">Select Student</option>';
            const studentsInClass = localStudents.filter(s => s.class === selectedClass);
            studentsInClass.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                studentSelect.appendChild(option);
            });
        }
        
        async function generateReportCard() {
            const studentId = document.getElementById('reportStudent').value;
            const studentClass = document.getElementById('reportClass').value;
            const term = document.getElementById('reportTerm').value;
            const reportDisplay = document.getElementById('report-card-display');
            const generateBtn = document.getElementById('generate-report-btn');
            generateBtn.textContent = "Generating...";
            generateBtn.disabled = true;

            if (!studentId || !studentClass || !term) {
                showMessageModal("Incomplete Form", "Please select a class, student, and term.");
                generateBtn.textContent = "Generate Report";
                generateBtn.disabled = false;
                return;
            }

            const student = localStudents.find(s => s.id === studentId);
            if (!student) {
                showMessageModal("Error", "Student not found.");
                generateBtn.textContent = "Generate Report";
                generateBtn.disabled = false;
                return;
            }
            
            try {
                const gradesDocRef = doc(db, `artifacts/${__app_id}/public/data/grades/${studentId}`);
                const gradesDoc = await getDoc(gradesDocRef);
                const grades = gradesDoc.exists() ? gradesDoc.data()[term] : {};

                if (!grades || Object.keys(grades).length === 0) {
                    showMessageModal("No Data", "No grades found for this student and term.");
                    generateBtn.textContent = "Generate Report";
                    generateBtn.disabled = false;
                    return;
                }

                const classType = studentClass.includes('JSS') ? 'JSS' : studentClass.split(' ')[1];
                const subjects = subjectSchema[classType];

                let tableRows = subjects.map(subject => {
                    const score = grades[subject] || 'N/A';
                    return `<tr><td class="subject">${subject}</td><td>${score}</td></tr>`;
                }).join('');

                const reportHTML = `
                    <div class="report-card-container">
                        <div class="rc-header">
                            <div class="rc-header-logo"><img src="https://i.ibb.co/6g2wz6Q/logo.jpg" alt="Logo"></div>
                            <div class="rc-header-text">
                                <h2>AL-AZEEZ PREMIER COLLEGE</h2>
                                <p>Epitome of Excellence</p>
                                <p><strong>Termly Report Card</strong> - Term ${term}</p>
                            </div>
                            <div class="rc-header-photo"><img src="https://ui-avatars.com/api/?name=${student.name.replace(' ','+')}" alt="Student Photo"></div>
                        </div>
                        <div class="rc-title">STUDENT INFORMATION</div>
                        <div class="rc-section">
                            <p><strong>Name:</strong> ${student.name}</p>
                            <p><strong>Class:</strong> ${student.class}</p>
                            <p><strong>Date of Birth:</strong> ${student.dob}</p>
                            <p><strong>Student ID:</strong> ${student.id.substring(0, 8)}</p>
                        </div>
                        <div class="rc-title">ACADEMIC PERFORMANCE</div>
                        <div class="rc-section">
                            <table class="rc-table">
                                <thead><tr><th>Subject</th><th>Score</th></tr></thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                        <div class="rc-grid-container">
                            <div class="rc-section rc-comments-section">
                                <p><strong>Teacher's Comments:</strong></p>
                                <textarea id="teacher-comment-${student.id}" placeholder="Enter comments here..."></textarea>
                            </div>
                            <div class="rc-section">
                                <p><strong>Next Term Begins:</strong> ${schoolInfo.nextTermBegins || 'TBA'}</p>
                                <p><strong>Teacher's Signature:</strong> ____________________</p>
                                <p><strong>Principal's Signature:</strong> ____________________</p>
                            </div>
                        </div>
                        <div class="rc-signature no-print">
                            <button class="btn btn-primary" onclick="window.print()">Print Report</button>
                        </div>
                    </div>
                `;
                reportDisplay.innerHTML = reportHTML;
            } catch (error) {
                console.error("Error generating report: ", error);
                showMessageModal("Error", "Failed to generate report card.");
            } finally {
                generateBtn.textContent = "Generate Report";
                generateBtn.disabled = false;
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            const nextTermDate = document.getElementById('nextTermBegins').value;
            saveSettingsBtn.textContent = "Saving...";
            saveSettingsBtn.disabled = true;
            try {
                await setDoc(doc(db, `artifacts/${__app_id}/public/data`, "schoolInfo"), { nextTermBegins: nextTermDate }, { merge: true });
                showMessageModal("Success", "Settings saved successfully!");
            } catch (error) {
                console.error("Error saving settings: ", error);
                showMessageModal("Error", "Failed to save settings.");
            } finally {
                saveSettingsBtn.textContent = "Save Settings";
                saveSettingsBtn.disabled = false;
            }
        }
        
        init();
    </script>
</body>
</html>
